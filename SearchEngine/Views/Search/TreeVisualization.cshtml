@using SearchEngine.DataStructures
@{
    ViewData["Title"] = "B+ Tree Visualization";
    var treeViz = ViewBag.TreeVisualization as TreeVisualization;
}

<div class="main-container" style="max-width: 100%; padding: 1rem;">
    <div class="page-header" style="margin-bottom: 1rem;">
        <div>
            <h1 class="page-title">B+ Tree Visualization</h1>
            <p class="page-subtitle">Visual representation of the inverted index data structure</p>
        </div>
        <div class="page-actions">
            <a href="@Url.Action("ViewIndex")" class="btn-modern btn-secondary-modern">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="8" y1="6" x2="21" y2="6"></line>
                    <line x1="8" y1="12" x2="21" y2="12"></line>
                    <line x1="8" y1="18" x2="21" y2="18"></line>
                    <line x1="3" y1="6" x2="3.01" y2="6"></line>
                    <line x1="3" y1="12" x2="3.01" y2="12"></line>
                    <line x1="3" y1="18" x2="3.01" y2="18"></line>
                </svg>
                View Index
            </a>
        </div>
    </div>

    @if (treeViz != null)
    {
        <div class="tree-stats">
            <div class="tree-stat">
                <span class="tree-stat-label">Order</span>
                <span class="tree-stat-value">@treeViz.Order</span>
            </div>
            <div class="tree-stat">
                <span class="tree-stat-label">Height</span>
                <span class="tree-stat-value">@treeViz.Height</span>
            </div>
            <div class="tree-stat">
                <span class="tree-stat-label">Total Keys</span>
                <span class="tree-stat-value">@treeViz.TotalKeys</span>
            </div>
        </div>
    }

    <div class="zoom-container">
        <!-- Zoom Controls -->
        <div class="zoom-controls">
            <button class="zoom-btn" id="zoomIn" title="Zoom In">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    <line x1="11" y1="8" x2="11" y2="14"></line>
                    <line x1="8" y1="11" x2="14" y2="11"></line>
                </svg>
            </button>
            <span class="zoom-level" id="zoomLevel">100%</span>
            <button class="zoom-btn" id="zoomOut" title="Zoom Out">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    <line x1="8" y1="11" x2="14" y2="11"></line>
                </svg>
            </button>
            <button class="zoom-btn" id="zoomReset" title="Reset View">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
                    <path d="M3 3v5h5"></path>
                </svg>
            </button>
            <button class="zoom-btn" id="zoomFit" title="Fit to View">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M8 3H5a2 2 0 0 0-2 2v3"></path>
                    <path d="M21 8V5a2 2 0 0 0-2-2h-3"></path>
                    <path d="M3 16v3a2 2 0 0 0 2 2h3"></path>
                    <path d="M16 21h3a2 2 0 0 0 2-2v-3"></path>
                </svg>
            </button>
        </div>

        <!-- Tree Canvas -->
        <div class="tree-viewport" id="treeViewport">
            <div class="tree-canvas" id="treeCanvas">
                @if (treeViz != null && treeViz.Root.Keys.Count > 0)
                {
                    <div class="tree">
                        @{ RenderHorizontalTree(treeViz.Root); }
                    </div>
                }
                else
                {
                    <div class="empty-state" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                        <div class="empty-state-icon">
                            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <rect x="3" y="3" width="7" height="7" rx="1"></rect>
                                <rect x="14" y="3" width="7" height="7" rx="1"></rect>
                                <rect x="3" y="14" width="7" height="7" rx="1"></rect>
                                <rect x="14" y="14" width="7" height="7" rx="1"></rect>
                            </svg>
                        </div>
                        <h3 class="empty-state-title">No Tree Data</h3>
                        <p class="empty-state-text">Add and index some documents to see the B+ Tree structure.</p>
                        <a href="@Url.Action("Index", "Document")" class="btn-modern btn-primary-modern">
                            Go to Documents
                        </a>
                    </div>
                }
            </div>
        </div>

        <!-- Instructions -->
        <div class="zoom-instructions">
            <span><kbd>Scroll</kbd> to zoom</span>
            <span><kbd>Drag</kbd> to pan</span>
            <span><kbd>Double-click</kbd> to reset</span>
        </div>
    </div>

    <div class="card-modern" style="margin-top: 1rem;">
        <div class="card-header-modern">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px; vertical-align: -2px;">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="16" x2="12" y2="12"></line>
                <line x1="12" y1="8" x2="12.01" y2="8"></line>
            </svg>
            Legend
        </div>
        <div class="card-body" style="display: flex; gap: 2rem; flex-wrap: wrap;">
            <div style="display: flex; align-items: center; gap: 0.75rem;">
                <div style="width: 28px; height: 28px; background: linear-gradient(145deg, #fef2f2 0%, #fecaca 100%); border: 3px solid #dc2626; border-radius: 50%;"></div>
                <span style="font-size: 0.875rem; color: var(--gray-600);">Root Node</span>
            </div>
            <div style="display: flex; align-items: center; gap: 0.75rem;">
                <div style="width: 24px; height: 24px; background: linear-gradient(145deg, #fff 0%, #eef2ff 100%); border: 2px solid var(--primary); border-radius: 50%;"></div>
                <span style="font-size: 0.875rem; color: var(--gray-600);">Internal Node</span>
            </div>
            <div style="display: flex; align-items: center; gap: 0.75rem;">
                <div style="width: 24px; height: 24px; background: linear-gradient(145deg, #fff 0%, #d1fae5 100%); border: 2px solid var(--success); border-radius: 50%;"></div>
                <span style="font-size: 0.875rem; color: var(--gray-600);">Leaf Node</span>
            </div>
        </div>
    </div>
</div>

@{
    void RenderHorizontalTree(TreeNodeVisualization node)
    {
        if (node == null || node.Keys.Count == 0) return;

        <ul>
            <li>
                <div class="node @(node.IsLeaf ? "leaf" : "internal")">
                    <div class="node-type">@(node.IsLeaf ? "Leaf" : "Internal")</div>
                    <div class="node-keys">
                        @foreach (var key in node.Keys)
                        {
                            <span class="key">@key</span>
                        }
                    </div>
                </div>
                @if (node.Children.Count > 0)
                {
                    <ul>
                        @foreach (var child in node.Children)
                        {
                            <li>
                                @{ RenderHorizontalTree(child); }
                            </li>
                        }
                    </ul>
                }
            </li>
        </ul>
    }
}

<style>
/* Zoom Container */
.zoom-container {
    background: var(--bg-primary);
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-lg);
    overflow: hidden;
    position: relative;
}

.zoom-controls {
    position: absolute;
    top: 1rem;
    right: 1rem;
    z-index: 100;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background: var(--bg-primary);
    padding: 0.5rem;
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    border: 1px solid var(--gray-200);
}

.zoom-btn {
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bg-tertiary);
    border: 1px solid var(--gray-200);
    border-radius: var(--radius);
    cursor: pointer;
    color: var(--gray-600);
    transition: var(--transition);
}

.zoom-btn:hover {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

.zoom-level {
    min-width: 50px;
    text-align: center;
    font-size: 0.8125rem;
    font-weight: 600;
    color: var(--gray-700);
    font-family: 'JetBrains Mono', monospace;
}

.zoom-instructions {
    position: absolute;
    bottom: 1rem;
    left: 50%;
    transform: translateX(-50%);
    z-index: 100;
    display: flex;
    gap: 1.5rem;
    background: rgba(0, 0, 0, 0.75);
    padding: 0.5rem 1rem;
    border-radius: var(--radius-full);
    font-size: 0.75rem;
    color: rgba(255, 255, 255, 0.9);
}

.zoom-instructions kbd {
    background: rgba(255, 255, 255, 0.2);
    padding: 0.125rem 0.375rem;
    border-radius: 0.25rem;
    font-family: inherit;
    margin-right: 0.25rem;
}

/* Tree Viewport */
.tree-viewport {
    width: 100%;
    height: 70vh;
    min-height: 500px;
    overflow: hidden;
    cursor: grab;
    background:
        radial-gradient(circle at 1px 1px, var(--gray-200) 1px, transparent 0);
    background-size: 24px 24px;
}

.tree-viewport:active {
    cursor: grabbing;
}

.tree-canvas {
    transform-origin: 0 0;
    display: flex;
    align-items: flex-start;
    justify-content: center;
    padding: 40px;
}

/* Tree Structure - Classic CS Textbook Style */
.tree {
    display: inline-block;
    padding: 20px;
}

.tree ul {
    position: relative;
    padding-top: 50px;
    display: flex;
    justify-content: center;
    list-style: none;
    margin: 0;
    padding-left: 0;
}

.tree li {
    position: relative;
    padding: 50px 8px 0 8px;
    display: flex;
    flex-direction: column;
    align-items: center;
}

/* Vertical line down from parent */
.tree li::before {
    content: '';
    position: absolute;
    top: 0;
    left: 50%;
    width: 2px;
    height: 50px;
    background: var(--gray-400);
}

/* Horizontal connector line */
.tree li::after {
    content: '';
    position: absolute;
    top: 0;
    width: 100%;
    height: 2px;
    background: var(--gray-400);
}

.tree li:only-child::after {
    display: none;
}

.tree li:first-child::after {
    left: 50%;
    width: 50%;
}

.tree li:last-child::after {
    right: 50%;
    width: 50%;
}

.tree > ul > li::before,
.tree > ul > li::after {
    display: none;
}

/* Node Styles - Circular like CS textbooks */
.node {
    width: 70px;
    height: 70px;
    border: 3px solid;
    border-radius: 50%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: white;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    transition: var(--transition);
    position: relative;
}

.node:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 20px rgba(0,0,0,0.2);
    z-index: 10;
}

/* ROOT NODE - Special styling */
.tree > ul > li > .node {
    width: 100px;
    height: 100px;
    border: 4px solid #dc2626;
    background: linear-gradient(145deg, #fef2f2 0%, #fecaca 100%);
    box-shadow: 0 8px 24px rgba(220, 38, 38, 0.3);
}

.tree > ul > li > .node .node-type {
    color: #dc2626;
    font-size: 0.6rem;
    top: -22px;
}

.tree > ul > li > .node .node-keys .key {
    background: #dc2626;
    font-size: 0.6rem;
    padding: 2px 8px;
}

.node.internal {
    border-color: var(--primary);
    background: linear-gradient(145deg, #fff 0%, #eef2ff 100%);
}

.node.leaf {
    border-color: var(--success);
    background: linear-gradient(145deg, #fff 0%, #d1fae5 100%);
}

.node-type {
    position: absolute;
    top: -20px;
    font-size: 0.5rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--gray-500);
    background: white;
    padding: 2px 6px;
    border-radius: 4px;
    white-space: nowrap;
}

.node-keys {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
    max-height: 50px;
    overflow: hidden;
}

.node-keys .key {
    background: var(--gray-800);
    color: white;
    padding: 1px 5px;
    border-radius: var(--radius-full);
    font-size: 0.5rem;
    font-family: 'JetBrains Mono', monospace;
    font-weight: 600;
    white-space: nowrap;
    max-width: 55px;
    overflow: hidden;
    text-overflow: ellipsis;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const viewport = document.getElementById('treeViewport');
    const canvas = document.getElementById('treeCanvas');

    if (!viewport || !canvas) return;

    let scale = 1;
    let translateX = 0;
    let translateY = 0;
    let isDragging = false;
    let startX, startY;
    let lastTranslateX, lastTranslateY;

    const minScale = 0.05;
    const maxScale = 3;

    function updateTransform() {
        canvas.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
        document.getElementById('zoomLevel').textContent = Math.round(scale * 100) + '%';
    }

    function fitToView() {
        const tree = canvas.querySelector('.tree');
        if (!tree) return;

        // Reset first to get accurate measurements
        scale = 1;
        translateX = 0;
        translateY = 0;
        canvas.style.transform = 'none';

        // Force reflow
        void canvas.offsetHeight;

        const viewportRect = viewport.getBoundingClientRect();
        const treeRect = tree.getBoundingClientRect();
        const canvasRect = canvas.getBoundingClientRect();

        // Calculate scale to fit tree with padding
        const padding = 80;
        const scaleX = (viewportRect.width - padding) / treeRect.width;
        const scaleY = (viewportRect.height - padding) / treeRect.height;
        scale = Math.min(scaleX, scaleY, 1.5);
        scale = Math.max(minScale, Math.min(maxScale, scale));

        // Calculate tree position relative to canvas
        const treeOffsetX = treeRect.left - canvasRect.left;
        const treeOffsetY = treeRect.top - canvasRect.top;

        // Center the tree in viewport
        const scaledTreeWidth = treeRect.width * scale;
        const scaledTreeHeight = treeRect.height * scale;

        translateX = (viewportRect.width - scaledTreeWidth) / 2 - (treeOffsetX * scale);
        translateY = (viewportRect.height - scaledTreeHeight) / 2 - (treeOffsetY * scale);

        updateTransform();
    }

    // Mouse wheel zoom
    viewport.addEventListener('wheel', function(e) {
        e.preventDefault();

        const rect = viewport.getBoundingClientRect();
        const mouseX = e.clientX - rect.left;
        const mouseY = e.clientY - rect.top;

        const delta = e.deltaY > 0 ? 0.9 : 1.1;
        const newScale = Math.max(minScale, Math.min(maxScale, scale * delta));

        // Zoom towards mouse position
        const scaleChange = newScale / scale;
        translateX = mouseX - (mouseX - translateX) * scaleChange;
        translateY = mouseY - (mouseY - translateY) * scaleChange;

        scale = newScale;
        updateTransform();
    });

    // Pan with mouse drag
    viewport.addEventListener('mousedown', function(e) {
        if (e.target.closest('.zoom-controls')) return;
        isDragging = true;
        startX = e.clientX;
        startY = e.clientY;
        lastTranslateX = translateX;
        lastTranslateY = translateY;
        viewport.style.cursor = 'grabbing';
    });

    document.addEventListener('mousemove', function(e) {
        if (!isDragging) return;
        translateX = lastTranslateX + (e.clientX - startX);
        translateY = lastTranslateY + (e.clientY - startY);
        updateTransform();
    });

    document.addEventListener('mouseup', function() {
        isDragging = false;
        viewport.style.cursor = 'grab';
    });

    // Double click to fit
    viewport.addEventListener('dblclick', function(e) {
        if (e.target.closest('.zoom-controls')) return;
        fitToView();
    });

    // Zoom buttons
    document.getElementById('zoomIn').addEventListener('click', function() {
        scale = Math.min(maxScale, scale * 1.25);
        updateTransform();
    });

    document.getElementById('zoomOut').addEventListener('click', function() {
        scale = Math.max(minScale, scale * 0.75);
        updateTransform();
    });

    document.getElementById('zoomReset').addEventListener('click', fitToView);
    document.getElementById('zoomFit').addEventListener('click', fitToView);

    // Initial fit - wait for rendering
    setTimeout(fitToView, 200);
    // Backup in case first didn't work
    setTimeout(fitToView, 500);
});
</script>

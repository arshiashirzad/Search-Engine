@model SearchEngine.Services.AdvancedSearchResult
@{
    ViewData["Title"] = "Advanced Search";
}

<div class="main-container">
    <div class="page-header">
        <div>
            <h1 class="page-title">Advanced Search</h1>
            <p class="page-subtitle">BM25 ranking with spell checking and highlighted results</p>
        </div>
        <div class="page-actions">
            <a href="@Url.Action("Index")" class="btn-modern btn-secondary-modern">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.3-4.3"></path>
                </svg>
                Simple Search
            </a>
        </div>
    </div>

    <div class="card-modern" style="margin-bottom: 2rem;">
        <div class="card-body" style="padding: 1.5rem;">
            <form method="get" asp-controller="Search" asp-action="AdvancedSearch">
                <div class="search-box" style="max-width: 100%;">
                    <svg class="search-icon" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.3-4.3"></path>
                    </svg>
                    <input type="text"
                           class="search-input"
                           name="query"
                           placeholder="Enter your search query..."
                           value="@ViewBag.Query"
                           autocomplete="off"
                           autofocus>
                    <button class="search-btn" type="submit">Search</button>
                </div>

                <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--gray-200);">
                    <label class="form-checkbox">
                        <input type="checkbox" name="enableSpellCheck" value="true" checked>
                        <span style="font-size: 0.875rem; color: var(--gray-600);">Enable spell checking</span>
                    </label>
                    <div style="display: flex; gap: 1.5rem; font-size: 0.8125rem; color: var(--gray-500);">
                        <span>
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px; vertical-align: -2px;">
                                <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                            </svg>
                            @ViewBag.TotalDocuments documents
                        </span>
                        <span>
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px; vertical-align: -2px;">
                                <line x1="8" y1="6" x2="21" y2="6"></line>
                                <line x1="8" y1="12" x2="21" y2="12"></line>
                                <line x1="8" y1="18" x2="21" y2="18"></line>
                                <line x1="3" y1="6" x2="3.01" y2="6"></line>
                                <line x1="3" y1="12" x2="3.01" y2="12"></line>
                                <line x1="3" y1="18" x2="3.01" y2="18"></line>
                            </svg>
                            @ViewBag.IndexedTerms terms indexed
                        </span>
                    </div>
                </div>
            </form>
        </div>
    </div>

    @if (Model != null)
    {
        @if (Model.SpellCorrection != null && Model.SpellCorrection.HasCorrections)
        {
            <div class="alert-modern alert-info" style="margin-bottom: 1.5rem;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 20h9"></path>
                    <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
                </svg>
                <div>
                    Did you mean:
                    <a href="@Url.Action("AdvancedSearch", new { query = Model.SpellCorrection.CorrectedQuery })"
                       style="font-weight: 600; color: inherit; text-decoration: underline;">
                        @Model.SpellCorrection.CorrectedQuery
                    </a>?
                </div>
            </div>
        }

        @if (Model.Results.Any())
        {
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem;">
                <p style="margin: 0; color: var(--gray-600);">
                    Found <strong style="color: var(--gray-900);">@Model.TotalResults</strong> result(s)
                    <span class="badge-modern badge-gray" style="margin-left: 0.5rem;">@Model.SearchTimeMs ms</span>
                </p>
            </div>

            <div class="animate-fade-in">
                @foreach (var result in Model.Results)
                {
                    <div class="result-card">
                        <div style="display: flex; align-items: flex-start; justify-content: space-between;">
                            <a href="@Url.Action("Details", "Document", new { id = result.Document.Id })" class="result-title">
                                @result.Document.Title
                            </a>
                            <span class="result-score">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                                </svg>
                                @result.Relevance.ToString("F3")
                            </span>
                        </div>
                        <p class="result-snippet">
                            @if (!string.IsNullOrEmpty(result.HighlightedSnippet))
                            {
                                @Html.Raw(result.HighlightedSnippet)
                            }
                            else
                            {
                                @(result.Document.Content.Length > 220
                                    ? result.Document.Content.Substring(0, 220) + "..."
                                    : result.Document.Content)
                            }
                        </p>
                        <div class="result-meta">
                            <span>
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px; vertical-align: -2px;">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                    <line x1="16" y1="2" x2="16" y2="6"></line>
                                    <line x1="8" y1="2" x2="8" y2="6"></line>
                                    <line x1="3" y1="10" x2="21" y2="10"></line>
                                </svg>
                                @result.Document.DateAdded.ToLocalTime().ToString("MMM dd, yyyy")
                            </span>
                        </div>
                    </div>
                }
            </div>

            @if (Model.TotalPages > 1)
            {
                <nav style="margin-top: 2rem;">
                    <ul style="display: flex; justify-content: center; gap: 0.5rem; list-style: none; padding: 0; margin: 0;">
                        @for (int i = 0; i < Model.TotalPages && i < 5; i++)
                        {
                            <li>
                                <a href="@Url.Action("AdvancedSearch", new { query = ViewBag.Query, page = i })"
                                   class="btn-modern @(i == Model.Page ? "btn-primary-modern" : "btn-secondary-modern")"
                                   style="min-width: 40px;">
                                    @(i + 1)
                                </a>
                            </li>
                        }
                    </ul>
                </nav>
            }
        }
        else if (!string.IsNullOrEmpty(Model.OriginalQuery))
        {
            <div class="empty-state">
                <div class="empty-state-icon">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.3-4.3"></path>
                        <line x1="8" y1="11" x2="14" y2="11"></line>
                    </svg>
                </div>
                <h3 class="empty-state-title">No results found</h3>
                <p class="empty-state-text">No documents match "<strong>@Model.OriginalQuery</strong>"</p>
            </div>
        }
    }
</div>
